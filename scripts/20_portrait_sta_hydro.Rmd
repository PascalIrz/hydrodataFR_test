---
title: "Portrait de station hydro"
author: "Pascal Irz"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# Préparation des données

## Activation des packages

```{r, class.source = 'fold-show'}
library(tidyverse)
library(ondetools)
library(hydrodataFR)
source(file = "fonctions_mise_en_forme_flextable.R")
library(flextable)
library(mapview)
```



## Téléchargement des débits en temps réel

```{r, class.source = 'fold-show'}
ma_sh <- "J0121510"

debit_tr <- bh_htr(stations_id = ma_sh,
                   grandeur_hydro = "Q") %>% 
  mutate(date_obs = lubridate::ymd_hms(date_obs), # format de la date
         debit = resultat_obs / 1000) %>%  # débits en m3/s
  select(-resultat_obs)
```



## Téléchargement caractéristiques station

```{r, class.source = 'fold-show'}
sh_data <- bh_sta_data(code_site = ma_sh)

libelle_ma_sh <- sh_data %>% 
  filter(code_site == ma_sh) %>% 
  pull(libelle_site)
```

## Chargement données de synthèse

Ces données ont été téléchargées et mises en forme auparavant (cf ....).

```{r, class.source = 'fold-show'}
load(file = "../processed_data/syntheses.RData")

sh_syn_data <- syntheses %>% 
  .[[ma_sh]]
```

# Constitution des éléments du portrait

## Palette de couleurs

```{r}
# Pour les graphiques
coul_em <- "#54b5c5" # ecoulements mensuels
coul_QMNA5 <- "red"
coul_module <- "brown"
coul_actuel <- "darkgreen" # temps réel

# Pour les tableaux
coul_estimations <- "red"
```


## Débit temps réel

`r libelle_ma_sh` : visualisation des premières lignes sur quelques colonnes.

```{r}
debit_tr %>% 
  head() %>%
  select(code_site, code_station, grandeur_hydro, date_obs, debit) %>% 
  flextable() %>% 
  mef()
```

```{r}
dern_obs <- debit_tr %>% 
  filter(date_obs == max(date_obs, na.rm = TRUE))

# flexdashboard::valueBox(value = dern_obs$debit,
#                         caption = "m3/s",
#                         icon = "fa-pencil")
  
```

Dernière observation de débit le `r dern_obs$date_obs %>% format('%d/%m/%Y')` à `r dern_obs$date_obs %>% lubridate::hour()`h`r dern_obs$date_obs %>% lubridate::minute()` : `r dern_obs$debit` $m^3/s$.

La courbe indique les valeurs récentes de débit et les barres bleu ciel les débits mensuels moyens issus des synthèses de la station.


```{r}
# Besoin pour ggplot de mettre le tableau des em avec les valeurs en colonnes (format long)
em_long <- sh_syn_data %>% 
  .[["em"]] %>%
  purrr::set_names(1:12) %>% 
  rownames_to_column(var = "variable") %>% 
  pivot_longer(cols = -variable, names_to = "mois", values_to = "em") %>% 
  filter(variable == "Debits (m3/s)") %>% 
  select(-variable)

# Ajout des em au tableau des débits temps réel
data <- debit_tr %>% 
  mutate(mois = lubridate::month(date_obs) %>% as.character) %>%
  left_join(y = em_long)

# Tableau qui va servir à indiquer module et QMNA5
hline_data <- data.frame(
  y = c(sh_syn_data$mm$`Module (moyenne) est`,
        sh_syn_data$be %>% .["Quinquennale seche",] %>% pull(`QMNA (m3/s) est`)),
  type = c("dashed", "solid"),
  couleur = c("brown", "red")
)

# Constitution du graphique
g_htr <- ggplot(data = data,
                aes(x = date_obs, y = debit)) +
  geom_col(aes(y = em), stat = "identity", width = 20000, alpha = 0.050, fill = coul_em) +
    geom_line(col = coul_actuel) +
  scale_x_datetime(date_labels = "%d/%m") + # étiquette axe des dates
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "", y = bquote('Débit ('*m^3/s*')'), title = libelle_ma_sh) + # légendes
  geom_hline(data = hline_data, aes(yintercept = y, col = couleur, linetype = type)) +
  scale_colour_manual(values = c("brown", "red"), 
                      labels = c("Module", "QMNA5"),
                      name = "Statistique") +
  scale_linetype_manual(values = c("solid", "dashed"), 
                        labels = c("Module", "QMNA5"),
                        name = "Statistique")

# Affichage du graphique 
g_htr
```

## Caractéristiques de la station

```{r}
# Comme on a un tableau à 35 colonnes et une lignes, on le transpose
# Sélection des colonnes à conserver
prov <- sh_data %>% 
  select(-(type_site:code_projection),
         -code_systeme_alti_site,
         -(statut_site:influence_generale_site),
         -(grandeur_hydro:date_maj_site),
         -(type_contexte_loi_stat_site:geometry))

# Récupération des noms des colonnes qui vont devenir des noms de lignes
noms_lignes <- colnames(prov)

# Nettoyage de certains champs
valeurs <- prov %>% 
  as.character() %>% 
  str_remove_all('list\\("') %>% 
  str_remove_all('\\)') %>% 
  str_remove_all('\\"')

# On recolle les noms des lignes et leurs valeurs
t_sh_data <- cbind(noms_lignes, valeurs) %>% 
  as.data.frame()

# Présentation du tableau
t_sh_data  %>% 
  flextable() %>% 
  mef() %>% 
  autofit() %>% 
  align(align = "left", part = "all")
```

## Synthèses statistiques

```{r}
couleur_estimations <- "red"
```


### Ecoulements mensuels

```{r}
sh_syn_data$em %>% 
  rownames_to_column("Variable") %>% 
  flextable() %>% 
  mef() %>% 
  vline(j = c('Variable'), part = "all") %>% 
  align(j = 1, align = "left")
```
```{r}
date_max <- dern_obs %>% 
  pull(date_obs) %>% 
  format("%d/%m/%Y")

bh_sy_ind_sta(syntheses = syntheses,
              sta_id = ma_sh,
              indicateur = "em") %>% 
  t() %>% # transposition
  as.data.frame() %>% # la transposition avais fait perdre la classe dataframe
  rownames_to_column("Mois") %>% # les mois sont mis dans une colonne, puis
  mutate(Mois = fct_inorder(Mois)) %>% # on les fige dans l'ordre chronologique
  ggplot(aes(x = Mois,
             y = `Debits (m3/s)`)) +
      geom_bar(stat = "identity",
               fill = coul_em) +
      labs(x = "", y = "Débit (m3/s)", title = libelle_ma_sh) +
  geom_hline(aes(yintercept = dern_obs$debit, linetype = as.factor(dern_obs$debit)),
             col = coul_actuel) +
    scale_linetype_manual(values = c("dashed"), 
                          labels = paste0("Débit au \n",
                                          date_max),
                          name = "") +
  geom_vline(xintercept = dern_obs$date_obs %>%
                            lubridate::day() %>% 
                            magrittr::subtract(15) %>% 
                            magrittr::divide_by(30) %>% 
                            magrittr::add(dern_obs$date_obs %>%
                                   lubridate::month()),
             linetype = "dashed",
             col = coul_actuel)
```


### Modules interannuels (naturels) - Débits

```{r}
sh_syn_data$mi %>% 
  rownames_to_column("Variable") %>% 
  flextable() %>% 
  set_header_labels(
    `Variable` = "Variable",
    `Quinquennale seche est` = "est.", `Quinquennale seche min` = "min.", `Quinquennale seche max` = "max.",
    `Mediane est` = "est.", `Mediane min` = "min.", `Mediane max` = "max.",
    `Quinquennale humide est` = "est.", `Quinquennale humide min` = "min.", `Quinquennale humide max` = "max.") %>% 
  color_est(couleur = couleur_estimations) %>% 
  add_header_row(colwidths = c(1, 3, 3, 3), values = c("", "Quinquennale sèche", "Médiane", "Quinquennale humide")) %>% 
  mef() %>% 
  vline(j = c('Variable', 'Quinquennale seche max', 'Mediane max'), part = "all") %>% 
  align(j = 1, align = "left", part = "all")
```


### Modules interannuels (naturels) - Moyenne

```{r}
sh_syn_data$mm %>% 
  rownames_to_column("Variable") %>% 
  flextable() %>% 
  set_header_labels(
    `Variable` = "Variable",
    `Module (moyenne) est` = "est.", `Module (moyenne) min` = "min.", `Module (moyenne) max` = "max.") %>% 
  color_est(couleur = couleur_estimations) %>% 
  add_header_row(colwidths = c(1, 3), values = c("", "Module (moyenne)")) %>% 
  mef() %>% 
  vline(j = c('Variable'), part = "all") %>% 
  align(j = 1, align = "left", part = "all")
```

### Basses eaux - Biennale et quinquennale

```{r}
sh_syn_data$be %>% 
  rownames_to_column("Periode de retour") %>% 
  flextable() %>% 
  set_header_labels(
    `Periode de retour` = "Période de retour",
    `VCN3 (m3/s) est` = "est.", `VCN3 (m3/s) min` = "min.", `VCN3 (m3/s) max` = "max.",
    `VCN10 (m3/s) est` = "est.", `VCN10 (m3/s) min` = "min.", `VCN10 (m3/s) max` = "max.",
    `QMNA (m3/s) est` = "est.", `QMNA (m3/s) min` = "min.", `QMNA (m3/s) max` = "max.") %>% 
  color_est(couleur = couleur_estimations) %>% 
  add_header_row(colwidths = c(1, 3, 3, 3), values = c("", "VCN3", "VCN10", "QMNA")) %>% 
  mef() %>%
  vline(j = c('Periode de retour', 'VCN3 (m3/s) max', 'VCN10 (m3/s) max'), part = "all") %>% 
  align(j = 1, align = "left", part = "all")
```

### Basses eaux - Moyenne et écart-type

```{r}
sh_syn_data$be2 %>% 
  rownames_to_column("Statistique") %>% 
  flextable() %>% 
  mef() %>% 
  vline(j = c('Statistique'), part = "all")
```

### Crues - Xo, Gradex

```{r}
sh_syn_data$cr %>% 
  rownames_to_column("Methode") %>% 
  flextable() %>% 
  set_header_labels(`Methode` = "Méthode") %>% 
  mef() %>% 
  vline(j = c('Methode'), part = "all")
```

### Crues - Périodes de retour

```{r}
sh_syn_data$cr2 %>% 
  rownames_to_column("Periode de retour") %>% 
  flextable() %>% 
  set_header_labels(
    `Periode de retour` = "Période de retour",
    `QJ (m3/s) est` = "est.", `QJ (m3/s) min` = "min.", `QJ (m3/s) max` = "max.",
    `QIX (m3/s) est` = "est.", `QIX (m3/s) min` = "min.", `QIX (m3/s) max` = "max.") %>% 
  color_est(couleur = couleur_estimations) %>% 
  add_header_row(colwidths = c(1, 3, 3), values = c("", "Qj", "QIX")) %>% 
  mef() %>% 
  vline(j = c('Periode de retour', 'QJ (m3/s) max'), part = "all") %>% 
  align(j = 1, align = "left", part = "all")

```

### Débits classés

```{r}
noms_colonnes <- sh_syn_data$dc %>% 
  colnames() %>% 
  str_sub(start = 3)

noms_colonnes <- c("Frequence", noms_colonnes)

sh_syn_data$dc %>% 
  rownames_to_column("Variable") %>% 
  purrr::set_names(noms_colonnes) %>% 
  flextable() %>% 
  set_header_labels(`Frequence` = "Fréquence") %>% 
  mef() %>% 
  vline(j = c('Frequence'), part = "all")
```


```{r}
geo_sta <- sh_data %>% 
  sf::st_as_sf(coords = c("coordonnee_x_site", "coordonnee_y_site"), crs = 2154)

# m <- mapview(geo_sta)
# 
# m@map %>% leaflet::setView(lng = sh_data[1, "longitude_site"],
#                            lat = sh_data[1, "latitude_site"],
#                            zoom = 8)
```

## Station(s) hydro en aval ?

```{r}
bv_shydro <- sf::read_sf("../raw_data/bv_stations_hydro_bretagnoide.gpkg")

codes_sta_hydr <- sf::st_join(geo_sta, bv_shydro) %>% 
  pull(codehydro)

bv_shydro <- bv_shydro %>% 
  filter(codehydro %in% codes_sta_hydr)

if (nrow(bv_shydro) > 1)
  
{
  
  bv_shydro <- bv_shydro %>% 
    filter(sbvcartesi == min(sbvcartesi))
}

shydro_geo <- bv_shydro %>% 
  sf::st_drop_geometry() %>% 
  sf::st_as_sf(coords = c("xl93", "yl93"), crs = 2154)

mapviewOptions(basemaps = c("OpenStreetMap", "Esri.WorldImagery", "OpenTopoMap"))

mapview(bv_shydro) +
  mapview(shydro_geo, col.regions = "red") +
  mapview(geo_sta)
```


